---
title: "Tablas GT y Spotify"
author: "RLadies BA"
date: '2022-07-30'
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      eval = TRUE,
                      warning = FALSE, 
                      message = FALSE, 
                      code_folding=TRUE,
                      align='center')

options(scipen=999)
```

# Librer√≠as

Se definen los paquetes :package: a utilizar:

```{r}
library(tidyverse) # Manipulaci√≥n de datos
library(gt)        # Tablas gt: grammar of tables
library(gtExtras)  # Extras de tablas gt
library(spotifyr)  # API de spotify
library(gtrendsR)  # Google trends API
library("rjson")
```

Se configura el token para conexi√≥n a la API de Spotify. El siguiente chunk buscar√° las variables de entorno:

-   SPOTIFY_CLIENT_ID

-   SPOTIFY_CLIENT_SECRET

```{r}
credentials <- fromJSON(file = "credentials.json")

Sys.setenv(SPOTIFY_CLIENT_ID = credentials$SPOTIFY_CLIENT_ID)
Sys.setenv(SPOTIFY_CLIENT_SECRET = credentials$SPOTIFY_CLIENT_SECRET)
```

Estas variables se obtienen con una cuenta en la p√°gina de desarrolladores de Spotify:

```{r}
access_token <- get_spotify_access_token()
```

Se puede acceder a los datos personales de artistas m√°s escuchados:

```{r, eval=FALSE}
tabla_user <- get_my_top_artists_or_tracks(
    type = 'artists', 
    time_range = 'short_term', #'short_term', # 'medium_term', 'long_term' 
    limit = 10) %>%
  select(name, genres) %>%
  rowwise() %>%
  mutate(genres = paste(genres, collapse = ', ')) %>%
  ungroup %>%
  gt()
```

# Caso: an√°lisis de un artista particular

Se define el artista a utilizar:

```{r}
ARTISTA = 'bad bunny'
```

Para este artista, se genera una b√∫squeda de variables:

```{r}

vars_audio = c(
    'danceability',
    'energy',
    'loudness',
    # 'liveness'
    # 'speechiness', 
    'acousticness', 
    'instrumentalness'
    # 'valence', 
    # 'tempo'       
)

tracks_features <- get_artist_audio_features(artist = ARTISTA) %>%
  select(
    artist_id,
    artist_name,
    album_id,
    album_name,
    album_release_date,
    album_images,
    track_name,
    available_markets,
    duration_ms,
    key_mode,
    
    # Variables vinculadas a la canci√≥n
    all_of(vars_audio)       
  ) %>% 
  
  arrange(desc(album_release_date))
```

Se cuenta con un df de variables vinculadas a cada canci√≥n de cada √°lbum del artista seleccionado:

```{r, eval=FALSE}
tabla_tracks <- tracks_features %>% 
  head() %>% gt()
```

```{r, eval=FALSE, echo=FALSE, layout='l-page'}
gt::gtsave(tabla_tracks, 'tabla_tracks.png', 
           vwidth = 2000, vheight = 3000)
```

```{r}
knitr::include_graphics('tabla_tracks.png')
```

Agregando los datos a nivel de cada √°lbum:

```{r}
tabla <- tracks_features %>%
  
  group_by(
    album_images, artist_name, album_id, album_name, album_release_date
  ) %>%
  
  summarise(
    # Duraci√≥n del √°lbum: suma de duraci√≥n de cada canci√≥n
    duration_mins = sum(duration_ms/(1000*60)),
    
    # Lista de cada variable de audio
    across(all_of(vars_audio), ~ list(.x)),
  ) %>% 
  
  ungroup()

```

```{r}
tabla_albums <- tabla %>% 
  select(-album_images) %>% 
  head() %>% gt() %>% 
  fmt_number(columns=where(is.numeric))
```

```{r, eval=FALSE, echo=FALSE, layout='l-page'}
gt::gtsave(tabla_albums, 'tabla_albums.png', 
           vwidth = 2000, vheight = 3000)
```

```{r}
knitr::include_graphics('tabla_albums.png')
```

Se quiere a√±adir la imagen del √°lbum

```{r}
get_imagen = function(album_images){
  album_images %>% 
    data.frame() %>% 
    filter(height==64) %>% 
    pull(url) %>% 
    as.character()
}
```

```{r}
tabla_album <- tabla %>% 
  mutate(album_images = map(album_images, ~get_imagen(album_images=.x))) %>% 
  distinct()
```

```{r}
color_spotify = "#1DB954"

tabla_album_2 <- tabla_album %>%  

  head() %>% 
  
  gt() %>% 
  
  tab_header(
    title = md(glue::glue('**{str_to_title(ARTISTA)}** en Spotify')),
    subtitle = '√Ålbumes m√°s recientes'
  ) %>% 
  
  text_transform(
    locations = cells_body(columns = c(album_images)),
    fn = function(album_images) {
      lapply(album_images, web_image, height = 50)
    }
  ) %>%
  
  gt_merge_stack(
    col1 = album_name, 
    col2 = artist_name) %>% 

  fmt_number(columns=where(is.numeric)) %>% 
  
  gt_color_box(columns = duration_mins, 
                palette=c('white', color_spotify), 
                domain=c(0,max(tabla_album$duration_mins))) %>% 
  
  gt_plt_dist(
    column = danceability, type = "density", line_color = "black", 
    fill_color = color_spotify) %>% 
  
  gt_plt_dist(
    column = energy, type = "density", line_color = "black", 
    fill_color = color_spotify) %>% 
  
  gt_plt_dist(
    column = loudness, type = "density", line_color = "black", 
    fill_color = color_spotify) %>% 
  
  gt_plt_dist(
    column = acousticness, type = "boxplot", line_color = "black", 
    fill_color = color_spotify) %>% 
  
  gt::cols_hide(instrumentalness) %>% 
  
  gt::tab_spanner(label='Un tipo de variables', 
                  columns=danceability:loudness) %>% 
  gt::tab_spanner(label='Otro tipo de variables', 
                  columns = c('acousticness','instrumentalness')) %>% 
  
  gt::tab_footnote(
    locations=cells_column_labels('duration_mins'), 
    footnote='Duraci√≤n en minutos = suma de la duraci√≥n de cada una de las canciones que componen el √°lbum') %>% 
  
  gt::tab_source_note(source_note='Fuente: API de Spotify') %>% 
  
  cols_label(
    album_images = '',
    album_name = '',
    album_release_date = 'Lanzamiento',
    duration_mins = 'Duraci√≥n',
    danceability = 'Danceability üï∫',
    energy = 'Energy',
    loudness = 'Loudness',
    acousticness = 'Acousticness',
    instrumentalness = 'Instrumentalness'
  ) 

tabla_album_2
```

```{r, eval=FALSE, echo=FALSE, layout='l-page'}
gt::gtsave(tabla_album_2, 'tabla_album_2.png', 
           vwidth = 2000, vheight = 3000)
```

```{r}
knitr::include_graphics('tabla_album_2.png')
```


```{r}
my_theme <- function(gt_object, ...){
  gt_object %>%
    tab_options(
      column_labels.background.color = "#39423c",
      footnotes.background.color = "#39423c",
      source_notes.background.color = "#39423c",
      heading.background.color = "#39423c",
      heading.align = "left",
      ...
    ) %>%
    tab_style(
      style = cell_text(color = color_spotify, size = px(32)),
      locations = cells_title("title")
    )
}

tabla_album_2 %>% 
    my_theme()
```








# Caso con boxplot

```{r}
is_outlier <- function(x) {
  # outliers <- x < quantile(x, 0.25) - 1.5 * IQR(x) | 
  #             x > quantile(x, 0.75) + 1.5 * IQR(x)
  
  outliers <- x == max(x)
  return(outliers)
}


gen_outliers_plots<- function(.df, .variable, .font_size=22){
  .df %>% 
    select(all_of(c('track_name',.variable))) %>% 
    pivot_longer(cols=-track_name) %>% 
    mutate(is_outlier=ifelse(is_outlier(value), track_name, NA)) %>% 
    ggplot(aes(y=value, x=name)) + 
      geom_boxplot(
        fill=color_spotify, width=0.2, lwd=3, outlier.size=5
      ) + 
      ggrepel::geom_text_repel(
        aes(label=is_outlier), 
        na.rm=TRUE, 
        nudge_x=0.4, 
        #position = position_nudge(x = +0.2),
        size=.font_size)+
      coord_flip()+
      theme_void()
}

gen_outliers_plots(
  .df=tracks_features %>% filter(album_id=='50Zz8CkIhATKUlQMbHO3k1'), 
  .variable='instrumentalness', .font_size=10)
```


```{r}

tabla_plots <- tabla_album %>% 
  mutate(instrumentalness=map(
    album_id, ~gen_outliers_plots(
      .df=tracks_features %>% filter(album_id==.x), 
      .variable='instrumentalness'
    )
  ))

tabla_album %>%  

  head() %>% 
  
  gt() %>% 
  
  tab_header(
    title = md(glue::glue('**{str_to_title(ARTISTA)}** en Spotify')),
    subtitle = '√Ålbumes m√°s recientes'
  ) %>% 
  
  text_transform(
    locations = cells_body(columns = c(album_images)),
    fn = function(album_images) {
      lapply(album_images, web_image, height = 50)
    }
  ) %>%
  
  gt_merge_stack(
    col1 = album_name, 
    col2 = artist_name) %>% 
  
  tab_style(
    style = list(cell_text(weight = "bold", color='red')),
    locations = cells_body(
      columns = album_release_date,
      rows = album_release_date >= '2022-01-01'
    )
  ) %>%

  fmt_number(columns=where(is.numeric)) %>% 
  
  gt_color_box(columns = duration_mins, 
                palette=c('white', color_spotify), 
                domain=c(0,max(tabla_album$duration_mins))) %>% 
  
  gt_plt_dist(
    column = danceability, type = "density", line_color = "black", 
    fill_color = color_spotify) %>% 
  
  gt_plt_dist(
    column = energy, type = "density", line_color = "black", 
    fill_color = color_spotify) %>% 
  
  gt_plt_dist(
    column = loudness, type = "density", line_color = "black", 
    fill_color = color_spotify) %>% 
  
  gt_plt_dist(
    column = acousticness, type = "boxplot", line_color = "black", 
    fill_color = color_spotify) %>% 
  
  text_transform(
    locations = cells_body(columns = instrumentalness),
    fn = function(x) {
      map(
        tabla_plots$instrumentalness,
        gt::ggplot_image,
        height = px(60),
        aspect_ratio = 2
      )
    }
  ) %>% 
  
  gt::tab_spanner(label='Un tipo de variables', 
                  columns=danceability:loudness) %>% 
  gt::tab_spanner(label='Otro tipo de variables', 
                  columns = c('acousticness','instrumentalness')) %>% 
  
  gt::tab_footnote(
    locations=cells_column_labels('duration_mins'), 
    footnote='Duraci√≤n en minutos = suma de la duraci√≥n de cada una de las canciones que componen el √°lbum.') %>% 
  
  gt::tab_footnote(
    locations=cells_column_labels('instrumentalness'), 
    footnote='En el caso de instrumentalness, al existir valores muy at√≠picos se muestra la canci√≥n a la que corresponde el m√°ximo valor en cada √°lbum.') %>% 
  
  gt::tab_source_note(source_note='Fuente: API de Spotify') %>% 
  
  cols_label(
    album_images = '',
    album_name = '',
    album_release_date = 'Lanzamiento',
    duration_mins = 'Duraci√≥n',
    danceability = 'Danceability üï∫',
    energy = 'Energy ‚ú®',
    loudness = 'Loudness üîä',
    acousticness = 'Acousticness üéπ',
    instrumentalness = 'Instrumentalness üéº'
  ) %>% 
  
  my_theme() %>% 
  
  gt::cols_hide(album_id)



```














# Tendencias

Se utiliza la API de Google trends para obtener la evoluci√≥n de las b√∫squedas realizadas para un √°lbum:

```{r}
ALBUM = 'LAS QUE NO IBAN A SALIR'
RELEASE_DATE = '2020-05-10'

trends <- gtrends(
  keyword = paste0(ARTISTA, ' ', tolower(ALBUM)),
  geo = "",
  time = "all"
)

```

Visualmente:

```{r}
trends %>%
  .$interest_over_time %>% 
  mutate(hits = ifelse(str_detect(hits, "<"),0,hits)) %>% 
  mutate(hits = as.numeric(hits)) %>% 
  ggplot(aes(x = date, y = hits)) +
  geom_line(colour = "darkblue", size = 0.7) +
  facet_wrap(~keyword) +
  theme_minimal()
```

Se genera una funci√≥n para realizar este gr√°fico:

```{r}
gen_trend_ggplot <- function(.album, .artista, .release_date) {
  if (tolower(.album) == tolower(.artista)) {
    .album = 'self titled'
  }
  
  gtrends(
    keyword = paste0(.artista, ' ', .album),
    geo = "",
    time = "today+5-y"
  ) %>%
    .$interest_over_time %>%
    mutate(hits = ifelse(str_detect(hits, "<"), 0, hits)) %>%
    mutate(hits = as.numeric(hits)) %>%
    ggplot(aes(x = date, y = hits)) +
    geom_line(color = "darkblue", size = 1) +
    geom_vline(xintercept = as.POSIXct(.release_date),
               color = 'red') +
    annotate(
      geom = 'text',
      x = as.POSIXct(.release_date) - lubridate::days(500),
      y = 90,
      size = 6,
      label = paste0('Publicaci√≥n'),
      color = 'red'
    ) +
    geom_curve(
      aes(
        x = as.POSIXct(.release_date) - lubridate::days(500) ,
        y = 85,
        xend = as.POSIXct(.release_date),
        yend = 75
      ),
      curvature = 0.3,
      angle = 40,
      color = 'red',
      size = 1,
      arrow = arrow(length = unit(0.3, "cm"))
    ) +
    labs(x = '', y = '%') +
    theme_minimal() +
    theme(axis.text = element_text(size = 14),
          title = element_text(size = 16))
}

```

```{r}
p <- gen_trend_ggplot(.album = ALBUM,
                 .artista = ARTISTA,
                 .release_date = RELEASE_DATE)

p 
```

# Tabla con ggplots

Se aplica esta funci√≥n sobre los √°lbumes de la tabla:

```{r, eval=FALSE}
tabla_plots <- tabla_album %>%  
  
  # Seleccionando los 5 √°lbumes m√°s recientes, para no hacer tantas consultas a la API (podr√≠a dar error):
  arrange(desc(album_release_date)) %>% 
  
  head(5) %>% 
  
  mutate(evolucion = map2(
    album_name, album_release_date,
    ~gen_trend_ggplot(.album =.x, 
                      .artista=ARTISTA, 
                      .release_date=.y)))
  

```

Visualizando la tabla final:

```{r, eval=FALSE}
tabla_final <- tabla_plots %>% 
  
 gt() %>% 
  
  text_transform(
    locations = cells_body(columns = c(album_images)),
    fn = function(album_images) {
      lapply(album_images, web_image, height = 50)
    }
  ) %>%
  
  cols_label(album_images = '') %>% 
    
  # Ggplots en formato gr√°fico (sino aparecen como texto)
  text_transform(
    locations = cells_body(columns = evolucion),
    fn = function(x) {
      map(
        tabla_plots$evolucion,
        gt::ggplot_image,
        height = px(180),
        aspect_ratio = 2
      )
    }
  ) %>% 
  
  fmt_number(columns=where(is.numeric))
```

```{r, eval=FALSE, echo=FALSE, layout='l-page'}
gt::gtsave(tabla_final, 'tabla_final.png', 
           vwidth = 2000, vheight = 3000)
```

```{r}
knitr::include_graphics('tabla_final.png')
```
